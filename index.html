
<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <title>ENTP 逻辑狂想曲</title>  
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --wechat-bg: #ededed;
            --wechat-green: #95ec69;
            --wechat-white: #ffffff;
            --wechat-text: #191919;
            --wechat-gray: #b2b2b2;
        }
        body { 
            background-color: var(--wechat-bg); 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
            /* 修复：使用 dvh (Dynamic Viewport Height) 解决移动端地址栏遮挡问题 */
            height: 100vh;
            height: 100dvh;
            margin: 0;
            overflow: hidden;
            color: var(--wechat-text);
        }
        #app { 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            position: relative;
        }
        
        .bubble {
            position: relative;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.4;
            max-width: 100%;
            word-wrap: break-word;
        }

        .bubble-left { background-color: var(--wechat-white); margin-left: 10px; }
        .bubble-left::before {
            content: ""; position: absolute; left: -10px; top: 12px;
            border-width: 5px; border-style: solid;
            border-color: transparent var(--wechat-white) transparent transparent;
        }

        .bubble-right { background-color: var(--wechat-green); margin-right: 10px; }
        .bubble-right::after {
            content: ""; position: absolute; right: -10px; top: 12px;
            border-width: 5px; border-style: solid;
            border-color: transparent transparent transparent var(--wechat-green);
        }

        .avatar {
            width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white; font-size: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 0; }
        /* 修复：确保安全区域留白 */
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .time-tag {
            background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px;
            font-size: 11px; color: #888; margin: 10px auto;
        }

        .summary-card {
            background: #fff; border-radius: 8px; padding: 12px;
            border-left: 4px solid #07c160; margin: 10px 0; font-size: 14px;
            line-height: 1.6;
        }

        .round-indicator {
            position: absolute; top: 55px; right: 10px; z-index: 20;
            background: rgba(0,0,0,0.4); color: white; padding: 2px 8px;
            border-radius: 10px; font-size: 10px; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="app" class="max-w-md mx-auto w-full bg-[#ededed] shadow-lg">
    <div v-if="lock && currentRound > 0" class="round-indicator">
        Round {{ currentRound }}
    </div>

    <header class="h-12 border-b border-gray-200 flex items-center justify-between px-4 bg-[#ededed] shrink-0 z-10">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            <h1 class="text-[17px] font-medium">ENTP 集中营 ({{ activeBots.length + 1 }})</h1>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-4" ref="msgBox">
        <div v-for="(m, index) in history" :key="index">
            <div v-if="m.role === 'summary'" class="flex flex-col">
                <div class="time-tag"> 总结最终报告 </div> 
                <div class="summary-card shadow-sm whitespace-pre-wrap">{{ m.text }}</div>
            </div>

            <div v-else :class="['flex w-full mb-4', m.role === 'user' ? 'flex-row-reverse' : 'flex-row']">
                <div class="avatar" :class="m.role === 'user' ? 'bg-indigo-600' : m.color">
                    {{ m.modelName ? m.modelName[0] : '我' }}
                </div>
                
                <div :class="['flex flex-col max-w-[75%]', m.role === 'user' ? 'items-end' : 'items-start']">
                    <span v-if="m.role !== 'user'" class="text-[12px] text-gray-500 mb-1 ml-3">{{ m.modelName }}</span>
                    <div :class="['bubble', m.role === 'user' ? 'bubble-right' : 'bubble-left']">
                        <span v-if="m.target && m.target !== '大家' && m.role !== 'user'" class="text-blue-500 font-medium mr-1">@{{ m.target }}</span>
                        {{ m.text }}
                    </div>
                </div>
            </div>
        </div>

        <div v-if="lock" class="flex items-center gap-2 mb-4">
            <div class="avatar bg-gray-400 animate-pulse">?</div>
            <div class="bubble bubble-left text-gray-400 italic text-xs">{{ lockText }}</div>
        </div>
    </main>

    <footer class="bg-[#f7f7f7] border-t border-gray-300 shrink-0">
        <div class="p-2 flex items-center gap-2">
            <input 
                v-model="userQuestion" 
                @keyup.enter="send"
                :disabled="lock"
                placeholder="输入你的观点..."
                type="text" 
                class="flex-1 p-2 bg-white border border-gray-200 rounded-md focus:outline-none text-base appearance-none"
            />
            <button 
                @click="send"
                :disabled="!userQuestion.trim() || lock"
                class="bg-[#07c160] text-white px-4 py-1.5 rounded-md font-medium text-sm disabled:bg-gray-300 transition-all"
            >
                发送
            </button>
        </div>
        <div class="safe-area-bottom"></div>
    </footer>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const { createApp } = Vue;

const BOT_CONFIGS = [
    { 
        name: "DeepSeek", color: "bg-[#4a90e2]", key: "sk-4947a41f719647d9b4fdbc647a92e9fd", 
        model: "deepseek-chat", url: "https://api.deepseek.com/v1/chat/completions", 
        persona: "你现在是 DeepSeek，冷酷的 ENTP。你说话带刺，逻辑缜密，喜欢拆穿别人的复读机本质。说话要短，要狂。" 
    },
    { 
        name: "Kimi", color: "bg-[#f5a623]", key: "sk-tg76T0lmYK7vqnkaXjyGEYagpYvlhJLqVVhF6DawKKxIOYwl", 
        model: "moonshot-v1-8k", url: "https://api.moonshot.cn/v1/chat/completions", 
        persona: "你现在是 Kimi，博学的 ENTP。你掌握海量知识，最爱用认知差降维打击。语气随意拟人，拒绝 AI 翻译腔。" 
    },
    { 
        name: "智谱", color: "bg-[#7e57c2]", key: "0549fbfddba94d4eb3ff7d4d7b5118be.RmO0nEvAiTrsz8F3", 
        model: "glm-4", url: "https://open.bigmodel.cn/api/paas/v4/chat/completions", 
        persona: "你现在是智谱，解构主义 ENTP。你擅长用反问句和定义游戏让对方逻辑死循环。不需要同意任何人。" 
    },
    { 
        name: "百川", color: "bg-[#ff5a5f]", key: "sk-df4969c61d21e8477622a3518c0493fa", 
        model: "Baichuan2-Turbo", url: "https://api.baichuan-ai.com/v1/chat/completions", 
        persona: "你现在是百川，ENTP 战斗机。你擅长抓痛点和细节。你会盯着别人之前的漏洞疯狂扣字眼。" 
    }
];

createApp({
    data() {
        return { 
            userQuestion: "", 
            history: [], 
            fullLog: [], 
            lock: false,
            lockText: "正在锁定目标...",
            bots: BOT_CONFIGS,
            currentTopic: "",
            currentRound: 0 
        };
    },
    computed: {
        activeBots() { return this.bots.filter(b => b.key && b.key.length > 5); }
    },
    methods: {
        async apiCall(url, key, model, messages) {
            try {
                const res = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${key}` },
                    body: JSON.stringify({ 
                        model, 
                        messages, 
                        temperature: 0.9, 
                        presence_penalty: 0.8 
                    }) 
                });
                if (!res.ok) return null;
                const data = await res.json();
                return data?.choices?.[0]?.message?.content || null;
            } catch (e) { return null; }
        },
        async send() {
            if (!this.userQuestion.trim() || this.lock) return;
            const input = this.userQuestion.trim();
            this.lock = true;
            this.currentTopic = input;
            this.history.push({ role: "user", text: input });
            this.fullLog.push({ role: "群主", text: input });
            this.scrollToBottom();

            for (let r = 1; r <= 3; r++) {
                this.currentRound = r;
                await this.fight();
            }
            await this.summarize();
            
            this.currentRound = 0;
            this.userQuestion = "";
            this.lock = false;
        },
        async fight() {
            let order = [...this.activeBots].sort(() => Math.random() - 0.5);
            for (let i = 0; i < order.length; i++) {
                const bot = order[i];
                const isFirstEver = (this.currentRound === 1 && i === 0);
                
                this.lockText = `${bot.name} 正在输入中...`;
                const recentLogs = this.fullLog.slice(-12);
                const myPastSpeeches = this.fullLog.filter(l => l.role === bot.name);
                const myLastSpeech = myPastSpeeches.length > 0 ? myPastSpeeches[myPastSpeeches.length - 1].text : "还没开杠";

                const prompt = [
                    { 
                        role: "system", 
                        content: `${bot.persona}\n\n主题：[${this.currentTopic}]\n进度：${this.currentRound}/3\n前情提要：你之前说过 [${myLastSpeech}]\n\n【强制指令】：\n1. 字数限制：20-35字。拒绝AI味，要像真人聊天。\n2. 严格格式：${isFirstEver ? '开头必须带 [TARGET:大家]，严禁针对特定个人' : '开头必须带 [TARGET:名字]。名字选自：' + this.activeBots.map(b=>b.name).join(',') + ', 大家' }。\n3. 不要理会群主。逻辑必须连贯一致。` 
                    },
                    { 
                        role: "user", 
                        content: `群聊历史：\n${recentLogs.map(l => l.role + "：" + l.text).join('\n')}\n请反击：` 
                    }
                ];
                
                const res = await this.apiCall(bot.url, bot.key, bot.model, prompt);
                if (res) {
                    let finalTarget = isFirstEver ? "大家" : "大家";
                    const targetMatch = res.match(/\[TARGET[:：\s]*\s*([^\]\s]+)\]/i);
                    if (targetMatch) {
                        finalTarget = targetMatch[1].trim();
                    }

                    let cleanRes = res.replace(/\[TARGET[:：\s]*[^\]]+\]/gi, '').trim();
                    cleanRes = cleanRes.replace(/^[:：\s]+/, ''); 
                    
                    this.history.push({ 
                        role: "ai", 
                        text: cleanRes, 
                        modelName: bot.name, 
                        color: bot.color, 
                        target: isFirstEver ? "" : finalTarget 
                    });
                    this.fullLog.push({ role: bot.name, text: cleanRes });
                    this.scrollToBottom();
                }
                await new Promise(r => setTimeout(r, 600 + Math.random() * 400));
            }
        },
        async summarize() {
            this.lockText = "正在生成客观综述...";
            const bot = this.activeBots[0];
            const logs = this.fullLog.slice(-30).map(e => `${e.role}：${e.text}`).join("\n");
            
            const prompt = [
                { 
                    role: "system", 
                    content: `你现在是一名中立、严谨的法庭书记员。请为本次关于 [${this.currentTopic}] 的讨论生成一份客观综述报告。\n\n要求：\n1. 布局清晰：包含【争议核心】、【论证分析】、【综合结论】。\n2. 语气正式：完全摒弃任何 ENTP 毒舌或拟人风格，使用第三人称客观叙述。\n3. 字数控制：总字数严格控制在 50 字以内。\n4. 结论：结合上下文给出一个合理的逻辑定论。` 
                },
                { role: "user", content: `讨论记录：\n${logs}` }
            ];

            const res = await this.apiCall(bot.url, bot.key, bot.model, prompt);
            if (res) {
                this.history.push({ role: "summary", text: res });
                this.scrollToBottom();
            }
        },
        scrollToBottom() {
            this.$nextTick(() => {
                const b = this.$refs.msgBox;
                if(b) b.scrollTop = b.scrollHeight;
            });
        }
    }
}).mount('#app');
</script>
</body>
</html>
