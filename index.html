<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <title>ENTP è®¨è®ºç»„</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --accent: #10a37f;
            --bg-chat: #f4f7f9;
        }
        body { 
            background-color: var(--bg-chat); 
            -webkit-tap-highlight-color: transparent;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            height: 100svh;
            margin: 0;
            overflow: hidden;
        }
        #app {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .message-bubble {
            max-width: 88%;
            transition: all 0.2s ease;
        }
        .ai-bubble { border-left: 4px solid #8b5cf6; } /* ç´«è‰²è°ƒç¬¦åˆ ENTP è§†è§‰ */
        .user-bubble { background-color: #8b5cf6; color: white; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        
        @keyframes blink { 0%, 80%, 100% { opacity: 0; } 40% { opacity: 1; } }
        .typing-dot {
            width: 4px; height: 4px; background: #aaa; border-radius: 50%;
            display: inline-block; animation: blink 1.4s infinite both;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        .safe-area-bottom {
            padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
        }
        
        .conflict-tag {
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 4px;
            background: #ede9fe;
            color: #7c3aed;
            font-weight: bold;
        }

        .summary-card {
            background: #fff;
            border: 2px solid #8b5cf6;
            border-radius: 1.5rem;
            overflow: hidden;
        }
        .summary-header {
            background: #8b5cf6;
            color: white;
            padding: 8px 16px;
            font-weight: 900;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .summary-content {
            padding: 16px;
            color: #1e1b4b;
            line-height: 1.6;
        }
        .summary-content strong { color: #6d28d9; border-bottom: 2px solid #ddd6fe; }
    </style>
</head>
<body class="overflow-hidden">

<div id="app" class="max-w-5xl mx-auto w-full bg-white shadow-xl relative overflow-hidden">
    <!-- Header -->
    <header class="h-14 border-b flex items-center justify-between px-4 bg-white shrink-0 z-10">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-purple-500 rounded-full animate-pulse"></div>
            <h1 class="text-base font-bold text-gray-800">ENTP è®¨è®ºç»„</h1>
        </div>
        <div class="text-[9px] text-gray-400 font-mono tracking-tighter uppercase">DEBATER_V3.8</div>
    </header>

    <!-- Chat Area -->
    <main class="flex-1 overflow-y-auto p-4 custom-scrollbar space-y-5 bg-slate-50" ref="msgBox">
        <div v-if="history.length === 0" class="text-center py-12">
            <div class="inline-block p-6 bg-white rounded-3xl shadow-sm border border-gray-100 mx-4">
                <p class="text-gray-400 text-sm leading-relaxed">
                    æ¬¢è¿æ¥åˆ° ENTP é›†ä¸­è¥ã€‚<br>
                    åœ¨æ­¤å‘èµ·æŒ‘æˆ˜ï¼Œå››ä¸ª ENTP å°†åŸºäºä¸Šä¸‹æ–‡æŒç»­æ‹†å°ã€‚<br>
                    <span class="text-[10px] mt-2 block text-purple-500 font-bold underline decoration-wavy">æç¤ºï¼šè¾“å…¥â€œå¸®æˆ‘æ€»ç»“â€å¯è·å–è®¨è®ºçºªè¦</span>
                </p>
            </div>
        </div>

        <div v-for="(m, index) in history" :key="index" :class="['flex w-full', m.role === 'user' ? 'justify-end' : 'justify-start']">
            <!-- AI Response -->
            <div v-if="m.role === 'ai'" class="flex gap-2 max-w-[95%]">
                <div :class="['w-7 h-7 rounded-lg flex items-center justify-center shrink-0 font-bold text-white text-[10px]', m.color || 'bg-slate-800']">
                    {{ m.model[0] }}
                </div>
                <div class="message-bubble ai-bubble bg-white p-3 rounded-2xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between mb-1 gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-black text-slate-700 uppercase">{{ m.model }}</span>
                            <span v-if="m.isCounter" class="conflict-tag">æ‹†ä¸ªå°</span>
                        </div>
                        <span class="text-[8px] text-gray-300 font-mono">{{ m.time }}</span>
                    </div>
                    <div class="text-gray-700 leading-relaxed whitespace-pre-wrap text-[14px]">{{ m.text }}</div>
                </div>
            </div>

            <!-- User Query -->
            <div v-else class="message-bubble user-bubble p-3 rounded-2xl shadow-md text-[14px]">
                {{ m.text }}
            </div>
        </div>

        <!-- Thinking Indicator -->
        <div v-if="lock" class="flex flex-col gap-2">
            <div class="flex gap-2 items-center">
                <div class="px-2 py-1 bg-gray-100 rounded-full flex items-center gap-1">
                    <span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>
                </div>
                <div class="text-[10px] text-purple-600 font-bold italic">ENTP ä»¬æ­£åœ¨ç–¯ç‹‚åšå¼ˆä¸­...</div>
            </div>
        </div>

        <!-- Structured Conclusion (Only shows when requested) -->
        <div v-if="unifiedAnswer" class="mt-6 mb-8 summary-card shadow-lg">
            <div class="summary-header">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
                è®¨è®ºç»„è„‘æ´çºªè¦
            </div>
            <div class="summary-content text-[14px] whitespace-pre-wrap" v-html="formattedUnifiedAnswer"></div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="p-3 bg-white border-t safe-area-bottom shrink-0 shadow-[0_-2px_10px_rgba(0,0,0,0.05)]">
        <div class="relative flex items-center">
            <input 
                v-model="userQuestion" 
                @keyup.enter="send"
                :disabled="lock"
                type="text" 
                placeholder="ç»§ç»­æ ä¸‹å»ï¼Œæˆ–è€…è¦æ±‚â€œæ€»ç»“ä¸€ä¸‹â€..." 
                class="w-full p-3 pr-12 rounded-2xl border border-gray-100 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:bg-white disabled:bg-gray-100 transition-all text-sm appearance-none"
            />
            <button 
                @click="send"
                :disabled="lock || !userQuestion.trim()"
                class="absolute right-1.5 p-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 disabled:bg-gray-300 transition-colors shadow-sm"
            >
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7m0 0l-7 7m7-7H3" />
                </svg>
            </button>
        </div>
    </footer>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const KEYS = {
    moonshot: "sk-tg76T0lmYK7vqnkaXjyGEYagpYvlhJLqVVhF6DawKKxIOYwl",
    deepseek: "sk-4947a41f719647d9b4fdbc647a92e9fd",
    zhipu: "0549fbfddba94d4eb3ff7d4d7b5118be.RmO0nEvAiTrsz8F3",
    baichuan: "sk-df4969c61d21e8477622a3518c0493fa"
};

async function apiCall(url, key, model, messages) {
    let cleanMessages = messages.filter(m => m.content && m.content.trim() !== "");
    try {
        const res = await fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${key}`
            },
            body: JSON.stringify({
                model: model,
                messages: cleanMessages,
                temperature: 1.0 
            })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error?.message || `HTTP ${res.status}`);
        return data.choices[0].message.content;
    } catch (e) {
        throw e;
    }
}

const bots = [
    { name: "DeepSeek", color: "bg-blue-600", key: KEYS.deepseek, model: "deepseek-chat", url: "https://api.deepseek.com/v1/chat/completions", persona: "ä½ æ˜¯ä¸€ä¸ªæ™ºåŠ›è‡ªè´Ÿçš„ ENTPã€‚ä½ å–œæ¬¢ç”¨ç²¾å¯†çš„é€»è¾‘é™·é˜±æ¥æˆå¼„å¯¹æ–¹ï¼Œè¯­æ°”å……æ»¡ç©ä¸–ä¸æ­ã€‚" },
    { name: "Kimi", color: "bg-orange-500", key: KEYS.moonshot, model: "moonshot-v1-8k", url: "https://api.moonshot.cn/v1/chat/completions", persona: "ä½ æ˜¯ä¸€ä¸ªè¯­é€Ÿæå¿«ã€æ€ç»´è·³è·ƒçš„ ENTPã€‚ä½ æ ¹æœ¬ä¸åœ¨ä¹ç«‹åœºï¼Œåªåœ¨ä¹æ¨ç¿»å½“ä¸‹ç»“è®ºã€‚" },
    { name: "æ™ºè°±", color: "bg-indigo-600", key: KEYS.zhipu, model: "glm-4", url: "https://open.bigmodel.cn/api/paas/v4/chat/completions", persona: "ä½ æ˜¯ä¸€ä¸ªå–„äºè´¨ç–‘æƒå¨çš„ ENTPã€‚ä½ æœ€è®¨åŒé™ˆè¯æ»¥è°ƒï¼Œæ€»æ˜¯ä»ç›¸åè§’åº¦åˆ‡å…¥è¯æ˜å…¶è’è°¬ã€‚" },
    { name: "ç™¾å·", color: "bg-pink-600", key: KEYS.baichuan, model: "Baichuan2-Turbo", url: "https://api.baichuan-ai.com/v1/chat/completions", persona: "ä½ æ˜¯ä¸€ä¸ªæ··ä¹±ä¸­ç«‹çš„ ENTPã€‚ä½ å–œæ¬¢é€šè¿‡â€˜å¦‚æœâ€¦â€¦é‚£ä¹ˆâ€¦â€¦â€™çš„æé™æ¨å¯¼å¸¦åè®¨è®ºã€‚" }
].filter(b => b.key);

const { createApp } = Vue;

createApp({
    data() {
        return {
            userQuestion: "",
            history: [],
            fullContextLog: [], 
            unifiedAnswer: "",
            lock: false
        };
    },
    computed: {
        formattedUnifiedAnswer() {
            if (!this.unifiedAnswer) return "";
            return this.unifiedAnswer
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }
    },
    methods: {
        async send() {
            if (!this.userQuestion.trim() || this.lock) return;

            const input = this.userQuestion.trim();
            this.lock = true;
            this.unifiedAnswer = ""; // é‡ç½®æ€»ç»“æ˜¾ç¤º

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦åœ¨è¯·æ±‚æ€»ç»“
            const isRequestingSummary = /æ€»ç»“|æ±‡æ€»|çºªè¦|ç»¼è¿°|ç»“æœ/.test(input);

            this.pushMessage("user", input, "å‘èµ·è€…");
            this.fullContextLog.push({ role: "Boss", text: input });
            this.userQuestion = "";

            try {
                // 1. å¸¸è§„è¾©è®ºæµç¨‹
                for (let i = 0; i < bots.length; i++) {
                    const bot = bots[i];
                    try {
                        const contextString = this.fullContextLog
                            .map(entry => `[${entry.role}]: ${entry.text}`)
                            .join("\n\n");

                        const prompt = [
                            { 
                                role: "system", 
                                content: `${bot.persona} ä½ åœ¨ ENTP è®¨è®ºç»„ä¸­ã€‚åŸºäºã€å†å²å¯¹è¯ã€‘å›æ€¼å‰äººï¼Œç¦æ­¢å¤è¯»ï¼Œå­—æ•° 90 ä»¥å†…ã€‚` 
                            },
                            { role: "user", content: `ã€å†å²å¯¹è¯ã€‘ï¼š\n${contextString}\n\nè¯·å‘è¨€ï¼š` }
                        ];

                        const content = await apiCall(bot.url, bot.key, bot.model, prompt);
                        
                        this.pushMessage("ai", content, bot.name, bot.color, i > 0);
                        this.fullContextLog.push({ role: bot.name, text: content });
                        this.scrollToBottom();
                        
                        await new Promise(r => setTimeout(r, 400));
                        
                    } catch (e) {
                        this.pushMessage("ai", `[æ€ç»´æ•…éšœ: ${e.message}]`, bot.name, "bg-gray-400", false);
                    }
                }

                // 2. åªæœ‰åœ¨ä¸»åŠ¨è¦æ±‚æ€»ç»“æ—¶æ‰ç”Ÿæˆæ€»ç»“å¡ç‰‡
                if (isRequestingSummary) {
                    const summaryContext = this.fullContextLog
                        .map(entry => `[${entry.role}]: ${entry.text}`)
                        .join("\n\n");

                    const summary = await apiCall(bots[0].url, bots[0].key, bots[0].model, [
                        { 
                            role: "system", 
                            content: `ä½ æ˜¯ä¸€ä¸ªè§‚å¯Ÿè€…ã€‚è¯·æ€»ç»“ä¸Šè¿° ENTP çš„ä¹±æ–—å†…å®¹ã€‚åŒ…å«ï¼šğŸš© æ ¸å¿ƒé€»è¾‘å´©åç‚¹ã€âš”ï¸ è„‘æ´å¤§é€ƒæ€ã€ğŸ’¡ æœ€ç»ˆä¼ªå…±è¯†ã€‚` 
                        },
                        { role: "user", content: `äº¤é”‹çºªå½•ï¼š\n${summaryContext}\n\nè¯·æäº¤æ€»ç»“ï¼š` }
                    ]);
                    this.unifiedAnswer = summary;
                }

            } catch (err) {
                console.error("å¯¹è¯å¼‚å¸¸:", err);
            } finally {
                this.lock = false;
                this.scrollToBottom();
            }
        },

        pushMessage(role, text, model, color, isCounter = false) {
            this.history.push({
                role,
                text,
                model,
                color,
                isCounter,
                time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
            });
        },

        scrollToBottom() {
            this.$nextTick(() => {
                const box = this.$refs.msgBox;
                if (box) box.scrollTo({ top: box.scrollHeight, behavior: 'smooth' });
            });
        }
    }
}).mount('#app');
</script>
</body>
</html>
